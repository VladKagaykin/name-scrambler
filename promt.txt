/home/avcd58/code/testcraft0/name-scrambler/build.gradle

plugins {
    id 'fabric-loom' version '1.1-SNAPSHOT'
    id 'maven-publish'
}

version = project.mod_version
group = project.maven_group

base {
    archivesName = project.archives_base_name
}

repositories {
    mavenCentral()
    maven { url "https://maven.fabricmc.net/" }
}

dependencies {
    minecraft "com.mojang:minecraft:${project.minecraft_version}"
    mappings "net.fabricmc:yarn:${project.yarn_mappings}:v2"
    modImplementation "net.fabricmc:fabric-loader:${project.loader_version}"
    modImplementation "net.fabricmc.fabric-api:fabric-api:${project.fabric_version}"
}

processResources {
    inputs.property "version", project.version
    filteringCharset "UTF-8"

    filesMatching("fabric.mod.json") {
        expand "version": project.version
    }
}

tasks.withType(JavaCompile).configureEach {
    it.options.encoding = "UTF-8"
    it.options.release = 17
}

java {
    withSourcesJar()
}

jar {
    from("LICENSE") {
        rename { "${it}_${project.archivesBaseName}"}
    }
}

/home/avcd58/code/testcraft0/name-scrambler/gradle.properties

# Gradle
org.gradle.jvmargs=-Xmx2G

# Fabric
minecraft_version=1.19.4
yarn_mappings=1.19.4+build.1
loader_version=0.14.21
fabric_version=0.76.0+1.19.4

# Mod
mod_version=1.0.0
maven_group=com.example
archives_base_name=name-scrambler

/home/avcd58/code/testcraft0/name-scrambler/src/main/resources/fabric.mod.json

{
  "schemaVersion": 1,
  "id": "name-scrambler",
  "version": "2.0.0",
  "name": "Name Scrambler + Proximity Chat",
  "description": "Hides player names with §k formatting + proximity chat system",
  "authors": ["AVCD"],
  "contact": {},
  "license": "MIT",
  "icon": "assets/namescrambler/icon.png",
  "environment": "*",
  "entrypoints": {
    "main": ["com.example.namescrambler.NameScramblerMod"]
  },
  "mixins": [
    "name-scrambler.mixins.json"
  ],
  "depends": {
    "fabricloader": ">=0.14.21",
    "minecraft": "1.19.4",
    "java": ">=17",
    "fabric-api": "*"
  }
}

/home/avcd58/code/testcraft0/name-scrambler/src/main/resources/name-scrambler.mixins.json

{
  "required": true,
  "minVersion": "0.8",
  "package": "com.example.namescrambler.mixin",
  "compatibilityLevel": "JAVA_17",
  "mixins": [
    "PlayerEntityMixin",
    "EntityMixin",
    "ServerPlayerEntityMixin",
    "ServerPlayNetworkHandlerMixin"
  ],
  "injectors": {
    "defaultRequire": 1
  }
}

/home/avcd58/code/testcraft0/name-scrambler/src/main/java/com/example/namescrambler/NameScramblerMod.java

package com.example.namescrambler;

import com.example.namescrambler.command.ProximityChatCommand;
import net.fabricmc.api.ModInitializer;
import net.fabricmc.fabric.api.command.v2.CommandRegistrationCallback;
import net.fabricmc.fabric.api.event.lifecycle.v1.ServerLifecycleEvents;
import net.fabricmc.fabric.api.networking.v1.ServerPlayConnectionEvents;
import net.minecraft.server.network.ServerPlayerEntity;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

public class NameScramblerMod implements ModInitializer {

    public static final Logger LOGGER = LogManager.getLogger("NameScrambler");
    public static final Config CONFIG = new Config();

    @Override
    public void onInitialize() {
        LOGGER.info("Name Scrambler + Proximity Chat mod by AVCD initialized!");

        // Загружаем конфиг при запуске сервера
        ServerLifecycleEvents.SERVER_STARTING.register(server -> {
            CONFIG.load();
            LOGGER.info("Proximity chat radius: {} blocks", CONFIG.chatRadius);
        });

        // Регистрируем команду
        CommandRegistrationCallback.EVENT.register((dispatcher, registryAccess, environment) -> {
            ProximityChatCommand.register(dispatcher);
        });

        // Добавляем обработчик входа игрока
        ServerPlayConnectionEvents.JOIN.register((handler, sender, server) -> {
            ServerPlayerEntity player = handler.getPlayer();
            setupPlayer(player);
        });
    }

    private void setupPlayer(ServerPlayerEntity player) {
        try {
            // Используем команды для создания команды с префиксом §k
            String teamName = "namescrambler_" + player.getUuid().toString().substring(0, 8);

            // Создаем команду
            player.getServer().getCommandManager().executeWithPrefix(
                player.getServer().getCommandSource().withSilent(),
                "team add " + teamName
            );

            // Устанавливаем префикс §k для команды
            player.getServer().getCommandManager().executeWithPrefix(
                player.getServer().getCommandSource().withSilent(),
                "team modify " + teamName + " prefix \"§k\""
            );

            // Добавляем игрока в команду
            player.getServer().getCommandManager().executeWithPrefix(
                player.getServer().getCommandSource().withSilent(),
                "team join " + teamName + " " + player.getGameProfile().getName()
            );

            LOGGER.info("Applied name hiding for: {}", player.getGameProfile().getName());

        } catch (Exception e) {
            LOGGER.error("Error setting up player: {}", e.getMessage());
        }
    }
}

/home/avcd58/code/testcraft0/name-scrambler/src/main/java/com/example/namescrambler/Config.java

package com.example.namescrambler;

import com.google.gson.Gson;
import com.google.gson.GsonBuilder;

import java.io.File;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;

public class Config {
    private static final Gson GSON = new GsonBuilder().setPrettyPrinting().create();
    private static final File CONFIG_FILE = new File("config/name-scrambler.json");

    public double chatRadius = 20.0;

    public void load() {
        try {
            if (CONFIG_FILE.exists()) {
                Config config = GSON.fromJson(new FileReader(CONFIG_FILE), Config.class);
                this.chatRadius = config.chatRadius;
                NameScramblerMod.LOGGER.info("AVCD Name Scrambler: Config loaded successfully");
            } else {
                // Создаем default config
                save();
                NameScramblerMod.LOGGER.info("AVCD Name Scrambler: Default config created");
            }
        } catch (Exception e) {
            NameScramblerMod.LOGGER.error("AVCD Name Scrambler: Failed to load config", e);
        }
    }

    public void save() {
        try {
            if (!CONFIG_FILE.getParentFile().exists()) {
                CONFIG_FILE.getParentFile().mkdirs();
            }
            FileWriter writer = new FileWriter(CONFIG_FILE);
            GSON.toJson(this, writer);
            writer.close();
        } catch (IOException e) {
            NameScramblerMod.LOGGER.error("AVCD Name Scrambler: Failed to save config", e);
        }
    }
}

/home/avcd58/code/testcraft0/name-scrambler/src/main/java/com/example/namescrambler/command/ProximityChatCommand.java

package com.example.namescrambler.command;

import com.example.namescrambler.NameScramblerMod;
import com.mojang.brigadier.Command;
import com.mojang.brigadier.CommandDispatcher;
import com.mojang.brigadier.arguments.DoubleArgumentType;
import net.minecraft.server.command.CommandManager;
import net.minecraft.server.command.ServerCommandSource;
import net.minecraft.text.Text;

public class ProximityChatCommand {

    public static void register(CommandDispatcher<ServerCommandSource> dispatcher) {
        dispatcher.register(CommandManager.literal("proximitychat")
            .requires(source -> source.hasPermissionLevel(4)) // Только для операторов (уровень 4)
            .then(CommandManager.literal("setradius")
                .then(CommandManager.argument("radius", DoubleArgumentType.doubleArg(1.0, 1000.0))
                    .executes(context -> {
                        double newRadius = DoubleArgumentType.getDouble(context, "radius");
                        ServerCommandSource source = context.getSource();

                        // Обновляем радиус в конфиге
                        NameScramblerMod.CONFIG.chatRadius = newRadius;
                        NameScramblerMod.CONFIG.save();

                        // Уведомляем оператора
                        source.sendMessage(Text.literal(
                            String.format("§aРадиус слышимости чата изменен на %.1f блоков", newRadius)
                        ));

                        NameScramblerMod.LOGGER.info("Operator {} set proximity chat radius to {}",
                            source.getName(), newRadius);

                        return Command.SINGLE_SUCCESS;
                    })
                )
            )
            .then(CommandManager.literal("getradius")
                .executes(context -> {
                    ServerCommandSource source = context.getSource();
                    double currentRadius = NameScramblerMod.CONFIG.chatRadius;
                    source.sendMessage(Text.literal(
                        String.format("§eТекущий радиус слышимости чата: %.1f блоков", currentRadius)
                    ));
                    return Command.SINGLE_SUCCESS;
                })
            )
            .then(CommandManager.literal("help")
                .executes(context -> {
                    ServerCommandSource source = context.getSource();
                    source.sendMessage(Text.literal("§6=== Proximity Chat Commands ==="));
                    source.sendMessage(Text.literal("§a/proximitychat setradius <число> §7- Установить радиус слышимости"));
                    source.sendMessage(Text.literal("§a/proximitychat getradius §7- Текущий радиус"));
                    source.sendMessage(Text.literal("§a/proximitychat help §7- Эта справка"));
                    return Command.SINGLE_SUCCESS;
                })
            )
        );
    }
}

/home/avcd58/code/testcraft0/name-scrambler/src/main/java/com/example/namescrambler/mixin/EntityMixin.java

package com.example.namescrambler.mixin;

import net.minecraft.entity.Entity;
import net.minecraft.entity.player.PlayerEntity;
import net.minecraft.text.Text;
import org.spongepowered.asm.mixin.Mixin;
import org.spongepowered.asm.mixin.injection.At;
import org.spongepowered.asm.mixin.injection.Inject;
import org.spongepowered.asm.mixin.injection.callback.CallbackInfoReturnable;

@Mixin(Entity.class)
public class EntityMixin {

    @Inject(method = "getDisplayName", at = @At("HEAD"), cancellable = true)
    private void replaceEntityDisplayName(CallbackInfoReturnable<Text> cir) {
        Entity entity = (Entity) (Object) this;
        if (entity instanceof PlayerEntity) {
            PlayerEntity player = (PlayerEntity) entity;
            Text scrambledName = Text.literal("§k" + player.getGameProfile().getName());
            cir.setReturnValue(scrambledName);
        }
    }

    @Inject(method = "getName", at = @At("HEAD"), cancellable = true)
    private void replaceEntityName(CallbackInfoReturnable<Text> cir) {
        Entity entity = (Entity) (Object) this;
        if (entity instanceof PlayerEntity) {
            PlayerEntity player = (PlayerEntity) entity;
            Text scrambledName = Text.literal("§k" + player.getGameProfile().getName());
            cir.setReturnValue(scrambledName);
        }
    }
}

/home/avcd58/code/testcraft0/name-scrambler/src/main/java/com/example/namescrambler/mixin/PlayerEntityMixin.java

package com.example.namescrambler.mixin;

import net.minecraft.entity.player.PlayerEntity;
import net.minecraft.text.Text;
import org.spongepowered.asm.mixin.Mixin;
import org.spongepowered.asm.mixin.injection.At;
import org.spongepowered.asm.mixin.injection.Inject;
import org.spongepowered.asm.mixin.injection.callback.CallbackInfoReturnable;

@Mixin(PlayerEntity.class)
public class PlayerEntityMixin {

    @Inject(method = "getDisplayName", at = @At("HEAD"), cancellable = true)
    private void replaceDisplayName(CallbackInfoReturnable<Text> cir) {
        PlayerEntity player = (PlayerEntity) (Object) this;
        Text scrambledName = Text.literal("§k" + player.getGameProfile().getName());
        cir.setReturnValue(scrambledName);
    }

    @Inject(method = "getEntityName", at = @At("HEAD"), cancellable = true)
    private void replaceEntityName(CallbackInfoReturnable<String> cir) {
        PlayerEntity player = (PlayerEntity) (Object) this;
        String scrambledName = "§k" + player.getGameProfile().getName();
        cir.setReturnValue(scrambledName);
    }
}

/home/avcd58/code/testcraft0/name-scrambler/src/main/java/com/example/namescrambler/mixin/ServerPlayerEntityMixin.java

package com.example.namescrambler.mixin;

import net.minecraft.server.network.ServerPlayerEntity;
import net.minecraft.text.Text;
import org.spongepowered.asm.mixin.Mixin;
import org.spongepowered.asm.mixin.injection.At;
import org.spongepowered.asm.mixin.injection.Inject;
import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;

@Mixin(ServerPlayerEntity.class)
public class ServerPlayerEntityMixin {

    @Inject(method = "onDisconnect", at = @At("HEAD"))
    private void onPlayerDisconnect(CallbackInfo ci) {
        ServerPlayerEntity player = (ServerPlayerEntity) (Object) this;
        player.setCustomName(null);
    }
}

/home/avcd58/code/testcraft0/name-scrambler/src/main/java/com/example/namescrambler/mixin/ServerPlayNetworkHandlerMixin.java

package com.example.namescrambler.mixin;

import com.example.namescrambler.NameScramblerMod;
import net.minecraft.network.message.SignedMessage;
import net.minecraft.server.MinecraftServer;
import net.minecraft.server.network.ServerPlayNetworkHandler;
import net.minecraft.server.network.ServerPlayerEntity;
import net.minecraft.text.Text;
import org.spongepowered.asm.mixin.Mixin;
import org.spongepowered.asm.mixin.Shadow;
import org.spongepowered.asm.mixin.injection.At;
import org.spongepowered.asm.mixin.injection.Inject;
import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;

import java.util.List;
import java.util.stream.Collectors;

@Mixin(ServerPlayNetworkHandler.class)
public class ServerPlayNetworkHandlerMixin {

    @Shadow public ServerPlayerEntity player;

    @Inject(
        method = "handleDecoratedMessage",
        at = @At("HEAD"),
        cancellable = true
    )
    private void handleProximityChat(SignedMessage signedMessage, CallbackInfo ci) {
        try {
            // Получаем содержимое сообщения из SignedMessage
            String content = signedMessage.getContent().getString();

            // Пропускаем команды
            if (content.startsWith("/")) {
                return;
            }

            ServerPlayerEntity sender = this.player;
            MinecraftServer server = sender.getServer();
            double radius = NameScramblerMod.CONFIG.chatRadius;

            // Находим игроков в радиусе
            List<ServerPlayerEntity> playersInRange = server.getPlayerManager().getPlayerList().stream()
                .filter(player -> {
                    if (player == sender) return true; // Отправитель всегда слышит себя
                    if (player.getWorld() != sender.getWorld()) return false; // Разные миры
                    double distance = player.getPos().distanceTo(sender.getPos());
                    return distance <= radius;
                })
                .collect(Collectors.toList());

            // Если в радиусе только отправитель
            if (playersInRange.size() <= 1) {
                sender.sendMessage(Text.literal("§cВас никто не услышал"));
                ci.cancel();
                return;
            }

            // Создаем сообщение со скрытым именем отправителя
            // §k - случайные символы, §r - сброс форматирования
            Text chatMessage = Text.literal("§k" + sender.getGameProfile().getName() + "§r: " + content);

            // Отправляем сообщение только игрокам в радиусе
            for (ServerPlayerEntity receiver : playersInRange) {
                receiver.sendMessage(chatMessage);
            }

            // Логируем в консоль
            NameScramblerMod.LOGGER.info("[Proximity] {}: {}", sender.getGameProfile().getName(), content);

            // Отменяем стандартную обработку сообщения
            ci.cancel();

        } catch (Exception e) {
            NameScramblerMod.LOGGER.error("Error in proximity chat", e);
        }
    }
}

